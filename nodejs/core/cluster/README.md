# cluster

node 进程集群。

## 工作原理

实现集群的两种方式：

1. 循环法，主进程监听端口，接受请求，并将请求以循环的方式转发给子进程。
2. 主检查创建监听套接字，并将它发送给感兴趣的子进程，然后子进程直接接入连接。

理论上第二种方式性能更好，但是实践中，由于操作系统调度机制难以捉摸，分发往往不均匀，可能8个进程中只有2个分发了 70% 的负载。

server.listen 将大部分工作交给了主进程，所以不同 nodejs 进程和 cluster 进程的区别是：

1. `server.listen({fd: 7})` 消息传给主进程，主进程的文件描述符 7 被监听，并将句柄传给工作进程，而不是监听文件描述符引用的工作进程。
2. `server.listen(handle)` 显示监听句柄，将使工作进程使用句柄。而不是与主进程通信。
3. `server.listen(0)` 会使服务器监听随机端口，但是在集群中，每个工作进程每次执行 `listen(0)` 会收到相同的随机端口。如果要监听不同的端口，则需要根据集群工作进程 id 生成端口号。
